# basis.net

Основой для реализации серверного взаимодействия в `basis.js` являются классы `Request` и `Transport`, описанные в `basis.net`.


`Transport` является своего рода менеджером запросов c определенными параметрами к определенной конечной точке на сервере (урлу, сервису и т.п.). Внутри себя он создает экземпляры класса `Request`, который является оберткой над стандартным объектом XMLHttpRequest и реализует интерфейс для формирования, отправки и обработки результатов запроса. Стоит заметить, что объекты Request используются только внутри Transport и их не нужно использовать напрямую.

При создании объекта `Transport` используются следующие основные параметры:

  * url - адрес конечной точки на сервере;
  * method - http-метод (`GET` по умолчанию);
  * params - объект, преобразующийся в queryString;
  * postBody - тело запроса (обычно это `JSON` или `XML`);
  * headers - заголовки запроса;
  * routerParams - используется для динамического создания url;
  * asynchronous - асинхронное/синхронное выполнение запроса (true/false).

Для создания запроса используется метод `request` объекта `Transport`. Метод принимает один параметр - это объект, в котором можно указать дополнительные параметры запроса или переопределить базовые параметры, указанные в конфиге `Transport`, то есть все те, что описаны выше.

`Transport` является потомком класса `basis.event.Emitter` и обладает следующим набором событий: 

  * start - возникает сразу перед отправкой запрос;
  * success(request, responseData) - возникает при успешной выполнении запроса;
  * failure(request, error) - возникает при неудачном выполнении запроса;
  * abort - возникает при отмене запроса (вручную или по таймауту);
  * complete - возникает при завершении запроса независимо от его статуса.

Пример создания простого объекта `Transport`:

```js
var transport = new basis.net.Transport({
  url: ‘/users’,
  method: ‘GET’,
  handler: {
    success: function(transport, result, request){
      // обработка успешного выполнения запроса
    },
    failure: function(transport, error){
      // обработка неудачного выполнения запроса
    }
  }
});

transport.request({
  params: {
    userId: ‘123’
  }
});
```

Также можно использовать специальную функцию-хелпер `basis.net.request` для создания и мгновенного выполнения запроса. Функция принимает три параметра `config`, `successCallback`, `failureCallback`. В ней создается объект `Transport`, добавляются обработчики и выполняет запрос с указанным конфигом.

```js
basis.net.request({
  url: ‘/users’,
  params: {
    userId: ‘123’
  }
}, function(){
  // обработка успешного выполнения запроса
});
```

Transport одновременно может выполнять несколько запросов. Количество одновременно выполняющихся запросов определяется свойством `poolLimit` объекта `Transport`. По достижению лимита, запросы ставятся в очередь и выполняются после того как выполнятся предыдущие запросы. Одновременно могут выполняться только запросы с разным хэшом (значением, которое уникально идентифицирует тот или иной запрос). Хэш вычисляется для каждого запроса в специальном методе `poolHashGetter` объекта `Transport`. В методе доступны все параметры запроса, по которым можно сформировать уникальный хэш. Запрос с одним и тем же хэшом отменяет предыдущий.

```js
var transport = new basis.net.Transport({
  url: ‘/users’,
  poolLimit: 5,
  poolHashGetter: function(requestData){
    return requestData.params.userId;
  }
});
transport.request({
  params: {
    userId: ‘123’
  }
});
transport.request({
  params: {
    userId: ‘321’
  }
});
```

В описанном примере оба запроса будут выполняться одновременно.